name: npm Publish

on:
  push:
    tags:
      - 'js-v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip actual publish)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64
          - os: macos-latest
            target: aarch64-apple-darwin
            strip: strip -x *.node

          # macOS x64
          - os: macos-13
            target: x86_64-apple-darwin
            strip: strip -x *.node

          # Linux x64 (glibc)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            strip: strip *.node

          # Linux ARM64 (glibc)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            setup: |
              sudo apt-get update
              sudo apt-get install -y gcc-aarch64-linux-gnu
            strip: aarch64-linux-gnu-strip *.node

          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            strip: ''

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: crates/tacet-napi

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: napi-${{ matrix.target }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup cross-compilation
        if: matrix.setup
        run: ${{ matrix.setup }}

      - name: Install dependencies
        run: bun install

      - name: Set cross-compile env (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Build native module
        run: bun run build:native --target ${{ matrix.target }}

      - name: Strip binary
        if: matrix.strip
        run: ${{ matrix.strip }}
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: crates/tacet-napi/*.node
          if-no-files-found: error
          retention-days: 1

  # Linux musl (Alpine)
  build-musl:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: crates/tacet-napi
    container:
      image: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-alpine
    steps:
      - uses: actions/checkout@v4

      - name: Install bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: $HOME/.bun/bin/bun install

      - name: Build native module
        run: |
          $HOME/.bun/bin/bun run build:native --target x86_64-unknown-linux-musl
          strip *.node

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-x86_64-unknown-linux-musl
          path: crates/tacet-napi/*.node
          if-no-files-found: error
          retention-days: 1

  # Test on native platforms
  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: crates/tacet-napi
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: crates/tacet-napi

      - name: Build TypeScript
        run: bun run build:ts

      - name: Run tests
        run: bun test
        timeout-minutes: 5

  # Publish to npm
  publish:
    needs: [build, build-musl, test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: crates/tacet-napi
    permissions:
      contents: read
      id-token: write  # Required for OIDC trusted publishing
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: crates/tacet-napi/artifacts

      - name: List artifacts
        run: ls -R artifacts

      - name: Move artifacts to npm directories
        run: bun x @napi-rs/cli artifacts --dir artifacts

      - name: List npm packages
        run: ls -la npm/

      - name: Build TypeScript
        run: bun run build:ts

      - name: Publish dry run
        if: inputs.dry_run == true
        run: |
          echo "=== Main package ==="
          npm pack --dry-run
          echo ""
          echo "=== Platform packages ==="
          for pkg in npm/*/; do
            echo "--- $pkg ---"
            (cd "$pkg" && npm pack --dry-run)
          done

      - name: Publish to npm
        if: inputs.dry_run != true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Publish platform packages first
          for pkg in npm/*/; do
            echo "Publishing $pkg..."
            (cd "$pkg" && npm publish --access public --provenance)
          done

          # Publish main package
          echo "Publishing main package..."
          npm publish --access public --provenance
