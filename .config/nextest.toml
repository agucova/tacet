# timing-oracle nextest configuration
#
# Test organization:
#   - core: Baseline validation (known_leaky, known_safe)
#   - crypto: Real crypto library timing tests (rustcrypto, ring, dalek, pqcrypto)
#   - synthetic: Attack patterns, effect patterns, exploitability
#   - calibration: Statistical calibration (FPR, power, coverage)
#   - unit: Fast config/types/helpers tests
#   - platform: PMU-based timing (kperf, perf)
#   - runtime: Async/concurrency tests
#   - macros: Proc macro tests
#   - investigation: One-off debugging (excluded from CI)

# =============================================================================
# Default Profile
# =============================================================================

[profile.default]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
retries = 0
# Exclude slow calibration and investigation tests from default runs
default-filter = "not (binary(calibration) | binary(investigation))"

# =============================================================================
# Speed Tiers
# =============================================================================

# Quick smoke tests (~5s, ~300 tests)
# Lib tests + unit tests only (no timing measurements)
# Usage: cargo nextest run --profile quick
[profile.quick]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "15s", terminate-after = 2 }
retries = 0
default-filter = "kind(lib) | binary(unit)"

# Smoke tests with sample crypto (~30s)
# Core + unit + fast crypto samples
# Usage: cargo nextest run --profile smoke
[profile.smoke]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "60s", terminate-after = 2 }
retries = 0
default-filter = """
(
  kind(lib) |
  binary(unit) |
  binary(core) |
  (binary(crypto) & test(/rustcrypto::blake2::rustcrypto_blake2b512_ct/)) |
  (binary(crypto) & test(/rustcrypto::chacha20poly1305::rustcrypto_chacha20poly1305_encrypt_ct/))
)
"""

# All crypto tests (~10min)
# Usage: cargo nextest run --profile crypto
[profile.crypto]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0
default-filter = "binary(crypto) | binary(core)"

# Full suite (~30min, excludes calibration and investigation)
# Usage: cargo nextest run --profile full
[profile.full]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "300s", terminate-after = 2 }
retries = 0
default-filter = "not (binary(calibration) | binary(investigation)) & not test(/#ignore/)"

# =============================================================================
# CI Profile
# =============================================================================

# Fast, reliable tests for CI (~1-2min)
# Excludes flaky crypto tests, power analysis, and platform-specific tests
# Runs: core (known_leaky/safe), unit, macros, runtime
# Usage: cargo nextest run --profile ci
[profile.ci]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "60s", terminate-after = 2 }
retries = 0
default-filter = """
(
  kind(lib) |
  binary(unit) |
  binary(core) |
  binary(macros) |
  binary(runtime)
) & not test(/#ignore/)
"""

# =============================================================================
# Category-Specific Profiles
# =============================================================================

# Calibration suite - quick/iteration tests only (~20min)
# Usage: cargo nextest run --profile calibration
[profile.calibration]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "600s", terminate-after = 2 }
retries = 0
default-filter = "binary(calibration)"

# Calibration suite - full validation (~2-3 hours)
# Includes #[ignore] validation tests for thorough pre-release verification
# Note: run-ignored is CLI-only in nextest, so use --run-ignored flag:
#   cargo nextest run --profile calibration-full --run-ignored all
# Or use justfile: just calibrate nextest-full
[profile.calibration-full]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "1800s", terminate-after = 2 }
retries = 0
default-filter = "binary(calibration)"

# Synthetic/attack pattern tests
# Usage: cargo nextest run --profile synthetic
[profile.synthetic]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0
default-filter = "binary(synthetic)"

# Investigation tests (one-off debugging, not for CI)
# Usage: cargo nextest run --profile investigation
[profile.investigation]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "600s", terminate-after = 2 }
retries = 0
default-filter = "binary(investigation)"

# =============================================================================
# Crypto Crate-Specific Profiles
# =============================================================================

# RustCrypto ecosystem tests
# Usage: cargo nextest run --profile rustcrypto
[profile.rustcrypto]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0
default-filter = "binary(crypto) & test(/^rustcrypto::/)"

# ring crate tests
# Usage: cargo nextest run --profile ring
[profile.ring]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0
default-filter = "binary(crypto) & test(/^ring::/)"

# dalek ecosystem tests
# Usage: cargo nextest run --profile dalek
[profile.dalek]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0
default-filter = "binary(crypto) & test(/^dalek::/)"

# Post-quantum crypto tests
# Usage: cargo nextest run --profile pqcrypto
[profile.pqcrypto]
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "180s", terminate-after = 3 }
retries = 0
default-filter = "binary(crypto) & test(/^pqcrypto::/)"

# =============================================================================
# Platform-Specific Profiles
# =============================================================================

# Timing-sensitive tests (single-threaded)
# Usage: cargo nextest run --profile timing
[profile.timing]
test-threads = 1
failure-output = "immediate"
status-level = "fail"
final-status-level = "fail"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0

# PMU-based timing (macOS kperf / Linux perf)
# Requires sudo, single-threaded for exclusive PMU access
# Usage: sudo -E cargo nextest run --profile platform
[profile.platform]
test-threads = 1
failure-output = "immediate"
status-level = "fail"
final-status-level = "fail"
slow-timeout = { period = "120s", terminate-after = 3 }
retries = 0
default-filter = "binary(platform)"

# Quick smoke with kperf/perf (requires sudo)
# Usage: sudo -E cargo nextest run --profile quick-kperf
[profile.quick-kperf]
test-threads = 1
failure-output = "immediate"
status-level = "pass"
final-status-level = "pass"
slow-timeout = { period = "30s", terminate-after = 2 }
retries = 0
default-filter = "kind(lib) | binary(unit) | binary(platform)"
