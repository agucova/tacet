# v5.1 Implementation Report

## Summary

Implemented spec v5.1 changes (S → R, two-step regularization, widened bounds). The large-effect validation test fails: P(leak) = 61% instead of expected >99%.

---

## Changes Implemented

1. **Prior shape matrix**: Changed from `S = Σ_rate / tr(Σ_rate)` to `R = D^(-1/2) Σ_rate D^(-1/2)` (correlation matrix)
2. **Two-step regularization**: Robust shrinkage (conditional) + numerical jitter (always)
3. **Calibration bounds**: Changed from `[0.1θ, 5θ]` to `[0.05θ, max(50θ, 10×median_SE)]`

---

## Test Case: SILENT Web App Dataset

**Input data:**
```
θ_eff = 100 ns
n = 10,000 samples

Δ (observed quantile differences):
  [10366, 13156, 13296, 12800, 11741, 12936, 13215, 11804, 18715] ns

SE (standard errors):
  [2731, 2796, 2612, 2555, 2734, 3125, 3953, 5662, 8105] ns

Σ_n diagonal (variance = SE²):
  [7.46e6, 7.82e6, 6.82e6, 6.53e6, 7.48e6, 9.76e6, 1.56e7, 3.21e7, 6.57e7] ns²
```

---

## Observed Behavior (v5.1 implementation)

```
sigma_prior = 61.3 ns

Prior covariance Λ₀ diagonal (all equal since diag(R)=1):
  [3.76e3, 3.76e3, 3.76e3, 3.76e3, 3.76e3, 3.76e3, 3.76e3, 3.76e3, 3.76e3] ns²

Precision ratio Σ_n[k,k] / Λ₀[k,k]:
  [1984, 2080, 1815, 1737, 1989, 2597, 4155, 8533, 17478]

Posterior mean δ_post:
  [5.2, 6.3, 7.3, 7.4, 5.9, 5.0, 3.2, 1.4, 1.1] ns

P(leak) = 0.61
```

---

## Comparison: Old v5.0 Behavior (from earlier diagnostic)

From diagnostic_webapp.rs run before v5.1 changes:

```
sigma_prior = 224.4 ns

P(leak) = 99.9% (at 1x base prior scale)
P(leak) = 100.0% (at 10x base prior scale)
```

---

## Calibration Bounds Check

```
θ_eff = 100 ns
median_SE = 2734 ns

Bounds: lo = 0.05 × 100 = 5 ns
        hi = max(50 × 100, 10 × 2734) = max(5000, 27340) = 27340 ns

Binary search converged to: sigma_prior = 61.3 ns
(Within bounds, achieves 62% exceedance target)
```

---

## Full Pipeline Output (analyze_silent example)

```
2. Web Application (web-diff-lan-10k.csv)
   Known vulnerability: Timing difference in web app response

   --- AdjacentNetwork (theta = 100ns) ---
   Raw quantile differences (baseline - test):
     10%: +10361.0ns  50%: +11761.0ns  90%: +18660.0ns
     All: [+10361, +13180, +13301, +12800, +11761, +12911, +13260, +11839, +18660]

   Leak probability P(effect > 100ns): 61.6%

   Effect decomposition:
     Shift (uniform):  11.69 ns
     Tail (asymmetric): -0.16 ns
     95% CI: [45.71, 236.53] ns
     Pattern: Indeterminate
   Quality: TooNoisy
   RESULT: INCONCLUSIVE - Sample budget exceeded
```

---

## Key Observations

1. **Calibration finds σ_prior ≈ 61 ns** to achieve 62% exceedance at θ=100 ns

2. **Prior variance (3.76e3) << Data variance (7.46e6 to 6.57e7)**
   - Ratio ranges from 1984:1 to 17478:1

3. **Posterior mean is heavily shrunk**
   - Observed Δ: 10,000-18,000 ns
   - Posterior δ_post: 1-7 ns

4. **P(leak) ≈ 62%**, which equals the prior exceedance target

5. **Old implementation gave σ_prior ≈ 224 ns** and P(leak) = 99.9%

---

## Files Modified

- `crates/timing-oracle-core/src/adaptive/calibration.rs` - main implementation
- `crates/timing-oracle/src/adaptive/calibration.rs` - caller updates
- `crates/timing-oracle/src/adaptive/single_pass.rs` - caller updates
- `crates/timing-oracle-c/src/lib.rs` - caller updates
- `crates/timing-oracle/examples/*.rs` - example updates

---

## Regression Test Code

```rust
#[test]
fn test_large_effect_noisy_likelihood_regression() {
    let delta = Vector9::from_row_slice(&[
        10366.0, 13156.0, 13296.0, 12800.0, 11741.0, 12936.0, 13215.0, 11804.0, 18715.0,
    ]);

    let ses = [2731.0, 2796.0, 2612.0, 2555.0, 2734.0, 3125.0, 3953.0, 5662.0, 8105.0];
    let mut sigma_n = Matrix9::zeros();
    for i in 0..9 {
        sigma_n[(i, i)] = ses[i] * ses[i];
    }

    let n = 10_000usize;
    let sigma_rate = sigma_n * (n as f64);
    let theta_eff = 100.0;
    let discrete_mode = false;
    let seed = 0xDEADBEEF_u64;

    let sigma_prior = calibrate_prior_scale(&sigma_rate, theta_eff, n, discrete_mode, seed);
    let prior_cov = compute_prior_cov_9d(&sigma_rate, sigma_prior, discrete_mode);
    let result = compute_bayes_factor(&delta, &sigma_n, &prior_cov, theta_eff, Some(seed));

    // FAILS: result.leak_probability = 0.61, not > 0.99
    assert!(result.leak_probability > 0.99);
}
```

---

## Raw Debug Output

```
sigma_prior = 61.30584716796875
Prior diagonal: [3.76e3, 3.76e3, ..., 3.76e3]
Sigma_n diagonal: [7.46e6, 7.82e6, ..., 6.57e7]
Precision ratio Σ_n/Λ₀: [1984.4475, 2080.0345, ..., 17478.4229]
P(leak) = 0.61
delta_post[0..3] = [5.2, 6.3, 7.3]
```
