---
title: C API
description: API documentation for the C bindings
sidebar:
  order: 2
---

C bindings for timing-oracle.

## Quick Reference

```c
#include <timing_oracle.h>

// Generator: zeros for baseline, random for sample
void generator(void *ctx, bool is_baseline, uint8_t *out, size_t size) {
    if (is_baseline) {
        memset(out, 0, size);
    } else {
        arc4random_buf(out, size);
    }
}

// Operation: the code being tested
void operation(void *ctx, const uint8_t *input, size_t size) {
    my_crypto_function(input, size);
}

int main(void) {
    to_config_t config = to_config_default(TO_ATTACKER_ADJACENT_NETWORK);
    config.time_budget_secs = 30.0;

    to_result_t result = to_test(&config, 32, generator, operation, NULL);

    switch (result.outcome) {
        case TO_OUTCOME_PASS:
            printf("No leak: P(leak)=%.1f%%\n", result.leak_probability * 100.0);
            break;
        case TO_OUTCOME_FAIL:
            printf("Leak: %.1f ns\n", result.effect.shift_ns);
            break;
        case TO_OUTCOME_INCONCLUSIVE:
            printf("Inconclusive: %s\n", to_inconclusive_reason_str(result.inconclusive_reason));
            break;
        case TO_OUTCOME_UNMEASURABLE:
            printf("Too fast: %s\n", result.recommendation);
            break;
    }

    to_result_free(&result);
    return result.outcome == TO_OUTCOME_FAIL ? 1 : 0;
}
```

---

## Building

```bash
git clone https://github.com/agucova/timing-oracle
cd timing-oracle
cargo build --release -p timing-oracle-c

# Headers at: crates/timing-oracle-c/include/timing_oracle.h
# Library at: target/release/libtiming_oracle_c.{a,so,dylib}
```

---

## Configuration

### Creating Configuration

```c
// Create with default settings for an attacker model
to_config_t config = to_config_default(TO_ATTACKER_ADJACENT_NETWORK);

// Customize as needed
config.time_budget_secs = 60.0;
config.max_samples = 50000;
```

### Attacker Models

| Enum Value | Threshold | Use Case |
|------------|-----------|----------|
| `TO_ATTACKER_SHARED_HARDWARE` | ~0.6 ns | SGX, containers |
| `TO_ATTACKER_POST_QUANTUM` | ~3.3 ns | Post-quantum crypto |
| `TO_ATTACKER_ADJACENT_NETWORK` | 100 ns | LAN, HTTP/2 |
| `TO_ATTACKER_REMOTE_NETWORK` | 50 μs | Public internet |
| `TO_ATTACKER_RESEARCH` | ~0 | Detect any difference |
| `TO_ATTACKER_CUSTOM` | User-defined | Custom threshold |

### Configuration Fields

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `attacker_model` | `to_attacker_model_t` | Required | Threat model |
| `threshold_ns` | `double` | Model-dependent | Threshold (for CUSTOM) |
| `time_budget_secs` | `double` | 30.0 | Max test duration |
| `max_samples` | `size_t` | 100000 | Max samples per class |
| `pass_threshold` | `double` | 0.05 | P(leak) below this → Pass |
| `fail_threshold` | `double` | 0.95 | P(leak) above this → Fail |

---

## Callbacks

### Generator Callback

```c
typedef void (*to_generator_fn)(void *context, bool is_baseline, uint8_t *output, size_t size);
```

Called **outside** the timed region to generate test inputs.

```c
void generator(void *ctx, bool is_baseline, uint8_t *output, size_t size) {
    if (is_baseline) {
        memset(output, 0, size);  // All zeros for baseline
    } else {
        arc4random_buf(output, size);  // Random for sample
    }
}
```

### Operation Callback

```c
typedef void (*to_operation_fn)(void *context, const uint8_t *input, size_t size);
```

Called **inside** the timed region. This is the code being tested.

```c
void operation(void *ctx, const uint8_t *input, size_t size) {
    // Your cryptographic operation
    crypto_verify(input, expected, size);
}
```

---

## Running Tests

```c
to_result_t to_test(
    const to_config_t *config,
    size_t input_size,
    to_generator_fn generator,
    to_operation_fn operation,
    void *context
);
```

---

## Result Types

### Outcome Enum

```c
typedef enum {
    TO_OUTCOME_PASS,         // No leak detected
    TO_OUTCOME_FAIL,         // Leak confirmed
    TO_OUTCOME_INCONCLUSIVE, // Cannot decide
    TO_OUTCOME_UNMEASURABLE  // Operation too fast
} to_outcome_t;
```

### Result Structure

```c
typedef struct {
    to_outcome_t outcome;
    double leak_probability;
    to_effect_t effect;
    to_exploitability_t exploitability;
    to_quality_t quality;
    to_inconclusive_reason_t inconclusive_reason;
    size_t samples_used;
    const char *recommendation;  // For UNMEASURABLE
} to_result_t;
```

### Effect Structure

```c
typedef struct {
    double shift_ns;
    double tail_ns;
    double credible_interval_low;
    double credible_interval_high;
    to_effect_pattern_t pattern;
} to_effect_t;
```

### Memory Management

```c
// Always free results when done
void to_result_free(to_result_t *result);
```

---

## Complete Example

```c
#include <timing_oracle.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

static uint8_t secret[32];

void generator(void *ctx, bool is_baseline, uint8_t *output, size_t size) {
    if (is_baseline) {
        memcpy(output, secret, size);  // Match secret for baseline
    } else {
        arc4random_buf(output, size);  // Random for sample
    }
}

void operation(void *ctx, const uint8_t *input, size_t size) {
    // Test constant-time comparison
    volatile int result = 0;
    for (size_t i = 0; i < size; i++) {
        result |= (secret[i] ^ input[i]);
    }
    (void)result;
}

int main(void) {
    // Initialize secret
    memset(secret, 0x42, sizeof(secret));

    to_config_t config = to_config_default(TO_ATTACKER_ADJACENT_NETWORK);
    config.time_budget_secs = 30.0;

    to_result_t result = to_test(&config, 32, generator, operation, NULL);

    printf("Outcome: %d\n", result.outcome);
    printf("Leak probability: %.1f%%\n", result.leak_probability * 100.0);

    if (result.outcome == TO_OUTCOME_FAIL) {
        printf("Effect: %.1f ns shift, %.1f ns tail\n",
               result.effect.shift_ns, result.effect.tail_ns);
    }

    to_result_free(&result);
    return result.outcome == TO_OUTCOME_FAIL ? 1 : 0;
}
```

### Compilation

```bash
gcc -o timing_test timing_test.c \
    -I/path/to/timing-oracle/crates/timing-oracle-c/include \
    -L/path/to/timing-oracle/target/release \
    -ltiming_oracle_c
```
